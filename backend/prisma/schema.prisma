generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  username     String    @unique
  name         String?
  displayName  String?
  bio          String?
  role         String?   @default("Creator")
  skills       String[]  @default([])
  password     String?
  googleId     String?   @unique
  githubId     String?   @unique
  appleId      String?   @unique
  avatarUrl    String?
  color        String?   @default("#000000")
  location     String?
  dateOfBirth  DateTime?
  socialLinks  Json?
  
  otp          String?
  otpExpiry    DateTime?
  isVerified   Boolean   @default(false)
  
  resetToken   String?
  resetTokenExpiry DateTime?
  isActive     Boolean   @default(true)
  tokenVersion Int       @default(0)
  lastActive   DateTime  @default(now())
  
  profileCompleted Boolean @default(false)
  
  socialInstagram String?
  socialTwitter   String?
  socialGithub    String?
  socialLinkedin  String?
  socialYoutube   String?
  socialWebsite   String?

  roomsCreated     Room[]            @relation("RoomCreator")
  roomParticipants RoomParticipant[]
  sessions         Session[]
  auditLogs        AuditLog[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  sessionToken String   @unique
  ipAddress    String
  userAgent    String?
  deviceName   String?
  lastActive   DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  ipAddress  String
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model IPLockout {
  id         String   @id @default(uuid())
  ipAddress  String   @unique
  attempts   Int      @default(0)
  lockUntil  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ipAddress])
}

model Room {
  id           String            @id @default(uuid())
  title        String
  description  String?
  thumbnail    String?
  visibility   RoomVisibility    @default(PUBLIC)
  createdBy    String
  isActive     Boolean           @default(true)
  crdtState    Bytes?
  drawingState Json?             @default("[]")
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @default(now()) @updatedAt

  creator      User              @relation("RoomCreator", fields: [createdBy], references: [id])
  participants RoomParticipant[]

  @@index([createdBy])
  @@index([visibility])
}

model RoomParticipant {
  roomId    String
  userId    String
  role      ParticipantRole
  joinedAt  DateTime        @default(now())

  room      Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
  @@index([userId])
}

enum RoomVisibility {
  PUBLIC
  PRIVATE
}

enum ParticipantRole {
  HOST
  PARTICIPANT
}
