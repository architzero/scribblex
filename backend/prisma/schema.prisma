generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  username     String    @unique
  name         String?
  displayName  String?
  bio          String?
  role         String?   @default("Creator")
  skills       String[]  @default([])
  password     String?
  googleId     String?   @unique
  githubId     String?   @unique
  appleId      String?   @unique
  avatarUrl    String?
  location     String?
  dateOfBirth  DateTime?
  socialLinks  Json?
  
  otp          String?
  otpExpiry    DateTime?
  isVerified   Boolean   @default(false)
  
  resetToken   String?
  resetTokenExpiry DateTime?
  isActive     Boolean   @default(true)
  tokenVersion Int       @default(0)
  lastActive   DateTime  @default(now())
  
  profileCompleted Boolean @default(false)
  
  socialInstagram String?
  socialTwitter   String?
  socialGithub    String?
  socialLinkedin  String?
  socialYoutube   String?
  socialWebsite   String?

  roomsOwned   Room[]         @relation("RoomOwner")
  memberships  RoomMember[]
  activities   Activity[]
  sessions     Session[]
  auditLogs    AuditLog[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  sessionToken String   @unique
  ipAddress    String
  userAgent    String?
  deviceName   String?
  lastActive   DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  ipAddress  String
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model IPLockout {
  id         String   @id @default(uuid())
  ipAddress  String   @unique
  attempts   Int      @default(0)
  lockUntil  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ipAddress])
}

model Room {
  id           String       @id @default(uuid())
  name         String
  isPublic     Boolean      @default(true)
  color        String       @default("#6366f1")
  description  String?
  thumbnail    String?
  ownerId      String
  lastActivity DateTime     @default(now())

  owner        User         @relation("RoomOwner", fields: [ownerId], references: [id])
  members      RoomMember[]
  activities   Activity[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model RoomMember {
  id       String   @id @default(uuid())
  userId   String
  roomId   String
  role     Role     @default(MEMBER)
  isOnline Boolean  @default(false)
  lastSeen DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  room     Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
}

model Activity {
  id        String       @id @default(uuid())
  type      ActivityType
  message   String
  roomId    String?
  userId    String

  room      Room?        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime     @default(now())
}

enum Role {
  OWNER
  MEMBER
}

enum ActivityType {
  ROOM_CREATED
  ROOM_JOINED
  USER_DRAWING
  USER_LEFT
}
